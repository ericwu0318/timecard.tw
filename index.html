<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>班數/班費計算機（日期時間版，8/6/6/4 半班）</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px 40px; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding: 18px; }
    h1 { font-size: 20px; margin: 0 0 6px; }
    .sub { color: #555; font-size: 13px; line-height: 1.45; margin-bottom: 14px; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 999px; background: #f0f3ff; color: #2a46c7; font-size: 12px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
    input, select, button {
      width: 100%; box-sizing: border-box;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid #d8dbe2; font-size: 14px; background: #fff;
    }
    input:focus, select:focus { outline: none; border-color: #6b8cff; box-shadow: 0 0 0 3px rgba(107,140,255,.15); }
    input[disabled] { background: #f3f4f7; color: #444; }

    .muted { font-size: 12px; color: #666; margin-top: 6px; line-height: 1.5; }
    .warn { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: #fff4e5; border: 1px solid #ffe1b5; color: #7a4a00; font-size: 13px; display: none; }

    .out { margin-top: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px) { .out { grid-template-columns: 1fr; } }

    .stat { border: 1px solid #eef0f5; background: #fbfcff; border-radius: 14px; padding: 12px; }
    .stat .k { font-size: 12px; color: #555; }
    .stat .v { font-size: 20px; font-weight: 700; margin-top: 4px; }

    .row3 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 720px) { .row3 { grid-template-columns: 1fr; } }

    /* ✅ 操作按鈕：用 auto-fit 避免手機擠爆 */
    .actions { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }

    button { cursor: pointer; border: none; background: #111; color: #fff; }
    button.secondary { background: #eef0f5; color: #111; border: 1px solid #d8dbe2; }
    button.ghost { background: #fff; color: #111; border: 1px solid #d8dbe2; }

    .note { margin-top: 12px; font-size: 12px; color: #666; line-height: 1.55; }

    /* ✅ 時間按鈕：手機不擠（輸入一排，按鈕一排），桌機才同列 */
    .dtBlock { display: grid; gap: 8px; }
    .btnRow { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .smallBtn {
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid #d8dbe2; background: #fff; color: #111;
      cursor: pointer; white-space: nowrap;
    }
    .smallBtn:active { transform: translateY(1px); }

    @media (min-width: 721px) {
      .dtBlock { grid-template-columns: 1fr auto; align-items: center; }
      .btnRow { grid-template-columns: auto auto; }
      .btnRow .smallBtn { width: auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>班數 / 班費計算機 <span class="pill">日期時間版（支援>24h）</span></h1>
      <div class="sub">
        預設：開啟頁面當下＝收工時間（結束）；開工時間預設為「結束時間往前 8 小時（1 班）」。<br>
        班數規則：0–8h=1；8–11=1.5；11–14=2；14–17=2.5；17–20=3；20–22=3.5；22–24=4；24h後每+2h=+0.5班。
      </div>

      <div class="grid">
        <div>
          <label>開始（年月日＋時間）</label>
          <div class="dtBlock">
            <input id="startDT" type="datetime-local" />
            <div class="btnRow">
              <button id="startMinusBtn" class="smallBtn" type="button">-30m</button>
              <button id="startPlusBtn" class="smallBtn" type="button">+30m</button>
            </div>
          </div>
          <div class="muted">開始時間 ±30 分鐘（跨日自動）。</div>
        </div>

        <div>
          <label>結束（年月日＋時間）</label>
          <div class="dtBlock">
            <input id="endDT" type="datetime-local" />
            <div class="btnRow">
              <button id="endMinusBtn" class="smallBtn" type="button">-30m</button>
              <button id="endPlusBtn" class="smallBtn" type="button">+30m</button>
            </div>
          </div>
          <div class="muted">結束時間 ±30 分鐘（跨日自動）。</div>
        </div>

        <div>
          <label>製作公司</label>
          <input id="prodCompany" type="text" placeholder="例如：影像力國際製作" />
        </div>

        <div>
          <label>製片</label>
          <input id="producer" type="text" placeholder="例如：大黑 / 阿佑" />
        </div>

        <div>
          <label>製片電話</label>
          <input id="producerPhone" type="tel" placeholder="例如：09xx-xxx-xxx" />
        </div>

        <div>
          <label>攝影師</label>
          <input id="dp" type="text" placeholder="例如：阿詮 / Kenny / 光哲" />
        </div>

        <div>
          <label>攝影電話</label>
          <input id="dpPhone" type="tel" placeholder="例如：09xx-xxx-xxx" />
        </div>

        <div>
          <label>收款類型</label>
          <select id="payType">
            <option value="回郵">回郵</option>
            <option value="匯款">匯款</option>
            <option value="現金">現金</option>
          </select>
        </div>

        <div>
          <label>案名</label>
          <input id="projectName" type="text" placeholder="例如：Mayday 夢想棚 / Porsche / 動力火車MV" />
        </div>

        <div>
          <label>職位</label>
          <select id="rateMode">
            <option value="assistant" selected>助理（3600/班）</option>
            <option value="leader">領班（5000/班）</option>
            <option value="custom">自選（可輸入班費）</option>
          </select>
          <div class="muted">只有選「自選」時，班費欄位才可修改。</div>
        </div>

        <div>
          <label>班費（每班）</label>
          <input id="ratePerShift" type="number" min="0" step="1" value="3600" disabled />
        </div>

        <div>
          <label>營所稅（發票加成）</label>
          <select id="taxRate">
            <option value="0.05" selected>5%（一般開發票）</option>
            <option value="0">0%（不加稅）</option>
          </select>
        </div>

        <div>
          <label>顯示設定</label>
          <select id="rounding">
            <option value="int" selected>金額取整數</option>
            <option value="none">保留小數</option>
          </select>
        </div>

        <div>
          <label>時區</label>
          <input id="tz" type="text" disabled />
        </div>
      </div>

      <div id="warnBox" class="warn"></div>

      <div class="out">
        <div class="stat">
          <div class="k">總工時</div>
          <div class="v" id="hoursOut">—</div>
        </div>
        <div class="stat">
          <div class="k">班數</div>
          <div class="v" id="shiftsOut">—</div>
        </div>
        <div class="stat">
          <div class="k">稅前（未稅）金額</div>
          <div class="v" id="pretaxOut">—</div>
        </div>
        <div class="stat">
          <div class="k">開發票後（含稅）金額</div>
          <div class="v" id="taxedOut">—</div>
        </div>
      </div>

      <!-- ✅ 修好 explainOut：避免 JS 直接炸掉 -->
      <div class="stat" style="margin-top:12px;">
        <div class="k">計算摘要</div>
        <div class="v" id="explainOut" style="font-size:14px;font-weight:600;line-height:1.55;">—</div>
      </div>

      <div class="row3">
        <div class="stat">
          <div class="k">一鍵複製（單行）</div>
          <div class="v" id="copyPreviewOne" style="font-size:14px;font-weight:700;line-height:1.55; word-break:break-all;">—</div>
          <div class="muted">格式：日期_公司_製片/攝影師_案名_職位_金額/含稅價_班數</div>
        </div>
        <div class="stat">
          <div class="k">一鍵複製（詳細）</div>
          <div class="v" id="copyPreviewDetail" style="font-size:14px;font-weight:600;line-height:1.55; white-space:pre-wrap;">—</div>
        </div>
      </div>

      <div class="actions">
        <button id="copyOneBtn" class="secondary" type="button">複製：單行</button>
        <button id="copyDetailBtn" class="secondary" type="button">複製：詳細</button>
        <button id="resetBtn" type="button">重設（重新帶入現在時間）</button>
      </div>

      <div class="note">
        小提醒：因為你已輸入日期，若結束早於開始，請直接把結束日期改到正確那一天（不再用“自動跨日”猜測）。
      </div>
    </div>
  </div>

<script>
  function calcShiftsByMinutes(totalMinutes) {
    if (totalMinutes <= 0) return 0;
    const t = totalMinutes;
    const H = (h) => h * 60;
    if (t <= H(8))  return 1;
    if (t <= H(11)) return 1.5;
    if (t <= H(14)) return 2;
    if (t <= H(17)) return 2.5;
    if (t <= H(20)) return 3;
    if (t <= H(22)) return 3.5;
    if (t <= H(24)) return 4;
    const extra = t - H(24);
    const halfSteps = Math.ceil(extra / H(2));
    return 4 + halfSteps * 0.5;
  }

  function pad2(n) { return String(n).padStart(2, "0"); }

  function toDTLocalValue(d) {
    const y = d.getFullYear();
    const m = pad2(d.getMonth() + 1);
    const day = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mm = pad2(d.getMinutes());
    return `${y}-${m}-${day}T${hh}:${mm}`;
  }

  function parseDTLocal(value) {
    const [datePart, timePart] = value.split("T");
    if (!datePart || !timePart) return null;
    const [y, m, d] = datePart.split("-").map(Number);
    const [hh, mm] = timePart.split(":").map(Number);
    return new Date(y, m - 1, d, hh, mm, 0, 0);
  }

  function fmtMoney(n, roundingMode) {
    const v = (roundingMode === "int") ? Math.round(n) : n;
    if (roundingMode === "int") return v.toLocaleString("zh-Hant-TW");
    return v.toLocaleString("zh-Hant-TW", { maximumFractionDigits: 2 });
  }

  function fmtHoursMinutes(totalMinutes) {
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    return `${h}小時${m}分`;
  }

  function mmdd(dateObj) { return `${pad2(dateObj.getMonth()+1)}/${pad2(dateObj.getDate())}`; }
  function ymd(dateObj) { return `${dateObj.getFullYear()}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`; }
  function hm(dateObj) { return `${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`; }
  function weekdayZh(d) { const w = ["日","一","二","三","四","五","六"][d.getDay()]; return `週${w}`; }

  const startDT = document.getElementById("startDT");
  const endDT = document.getElementById("endDT");

  const prodCompany = document.getElementById("prodCompany");
  const producer = document.getElementById("producer");
  const producerPhone = document.getElementById("producerPhone");

  const dp = document.getElementById("dp");
  const dpPhone = document.getElementById("dpPhone");

  const payType = document.getElementById("payType");
  const projectName = document.getElementById("projectName");

  const rateMode = document.getElementById("rateMode");
  const ratePerShift = document.getElementById("ratePerShift");
  const taxRate = document.getElementById("taxRate");
  const rounding = document.getElementById("rounding");
  const tz = document.getElementById("tz");

  const warnBox = document.getElementById("warnBox");
  const hoursOut = document.getElementById("hoursOut");
  const shiftsOut = document.getElementById("shiftsOut");
  const pretaxOut = document.getElementById("pretaxOut");
  const taxedOut = document.getElementById("taxedOut");
  const explainOut = document.getElementById("explainOut");

  const copyPreviewOne = document.getElementById("copyPreviewOne");
  const copyPreviewDetail = document.getElementById("copyPreviewDetail");

  let lastCustomRate = 3600;

  function roleText() {
    if (rateMode.value === "assistant") return "助理";
    if (rateMode.value === "leader") return "領班";
    return "自選";
  }

  function safeText(s) {
    return (s || "—").trim().replaceAll("_", "＿");
  }

  function showWarn(msg) { warnBox.textContent = msg; warnBox.style.display = "block"; }
  function clearWarn() { warnBox.textContent = ""; warnBox.style.display = "none"; }

  function setDefaultsToNow() {
    const now = new Date();
    endDT.value = toDTLocalValue(now);
    startDT.value = toDTLocalValue(new Date(now.getTime() - 11 * 60 * 60 * 1000));
  }

  function applyRateMode() {
    const mode = rateMode.value;
    if (mode === "assistant") { ratePerShift.value = 3600; ratePerShift.disabled = true; }
    else if (mode === "leader") { ratePerShift.value = 5000; ratePerShift.disabled = true; }
    else { ratePerShift.disabled = false; ratePerShift.value = lastCustomRate; setTimeout(() => ratePerShift.focus(), 0); }
  }

  function bumpDT(dtInputEl, deltaMinutes) {
    if (!dtInputEl.value) return;
    const d = parseDTLocal(dtInputEl.value);
    if (!d) return;
    dtInputEl.value = toDTLocalValue(new Date(d.getTime() + deltaMinutes * 60000));
    calculate();
  }

  function calculate() {
    clearWarn();
    if (!startDT.value || !endDT.value) return;

    const s = parseDTLocal(startDT.value);
    const e = parseDTLocal(endDT.value);
    if (!s || !e) return;

    const diffMs = e.getTime() - s.getTime();
    if (diffMs <= 0) {
      showWarn("⚠️ 結束時間早於（或等於）開始時間。請把結束日期/時間改到正確那一天。");
      hoursOut.textContent = shiftsOut.textContent = pretaxOut.textContent = taxedOut.textContent = copyPreviewOne.textContent = copyPreviewDetail.textContent = explainOut.textContent = "—";
      return;
    }

    const totalMinutes = Math.round(diffMs / 60000);
    const shifts = calcShiftsByMinutes(totalMinutes);

    const rate = Number(ratePerShift.value || 0);
    const pretax = shifts * rate;
    const tax = Number(taxRate.value || 0);
    const taxed = pretax * (1 + tax);

    const shiftsText = shifts.toFixed(1).replace(/\.0$/, "");

    hoursOut.textContent = fmtHoursMinutes(totalMinutes);
    shiftsOut.textContent = shiftsText;
    pretaxOut.textContent = `$ ${fmtMoney(pretax, rounding.value)}`;
    taxedOut.textContent = `$ ${fmtMoney(taxed, rounding.value)}`;
    explainOut.textContent = `${shiftsText} 班 × ${rate.toLocaleString("zh-Hant-TW")} = 未稅 $${fmtMoney(pretax, rounding.value)}；含稅 $${fmtMoney(taxed, rounding.value)}`;

    // 單行：日期_公司_製片/攝影師_案名_職位_金額/含稅價_班數
    const who = [producer.value, dp.value].filter(v => (v || "").trim()).join("/");
    copyPreviewOne.textContent =
      `${mmdd(s)}_${safeText(prodCompany.value)}_${safeText(who)}_${safeText(projectName.value)}_${roleText()}_$${fmtMoney(pretax, rounding.value)}/$${fmtMoney(taxed, rounding.value)}_${shiftsText}班`;

    // 詳細
    const sameDay = ymd(s) === ymd(e);
    const timeLine = sameDay
      ? `${ymd(s)}（${weekdayZh(s)}） ${hm(s)}-${hm(e)}｜工時${hoursOut.textContent}｜${shiftsText}班`
      : `${ymd(s)} ${hm(s)}｜${ymd(e)} ${hm(e)}｜工時${hoursOut.textContent}｜${shiftsText}班`;

    copyPreviewDetail.textContent =
      `${timeLine}\n` +
      `公司：${prodCompany.value || "—"}\n` +
      `製片：${producer.value || "—"}｜電話：${producerPhone.value || "—"}\n` +
      `攝影：${dp.value || "—"}｜電話：${dpPhone.value || "—"}\n` +
      `收款：${payType.value || "—"}\n` +
      `案名：${projectName.value || "—"}\n` +
      `職位：${roleText()}｜班費：${rate.toLocaleString("zh-Hant-TW")}/班｜未稅：$${fmtMoney(pretax, rounding.value)}｜含稅：$${fmtMoney(taxed, rounding.value)}`;
  }

  // 時間 ±30m
  document.getElementById("startMinusBtn").addEventListener("click", () => bumpDT(startDT, -30));
  document.getElementById("startPlusBtn").addEventListener("click", () => bumpDT(startDT, +30));
  document.getElementById("endMinusBtn").addEventListener("click", () => bumpDT(endDT, -30));
  document.getElementById("endPlusBtn").addEventListener("click", () => bumpDT(endDT, +30));

  // 複製
  async function copyText(text) {
    try { await navigator.clipboard.writeText(text); alert("已複製到剪貼簿"); }
    catch { alert("複製失敗（可能是瀏覽器權限），你可以手動複製預覽區文字。"); }
  }
  document.getElementById("copyOneBtn").addEventListener("click", () => copyText(copyPreviewOne.textContent));
  document.getElementById("copyDetailBtn").addEventListener("click", () => copyText(copyPreviewDetail.textContent));

  // 其他按鈕

  document.getElementById("resetBtn").addEventListener("click", () => {
    rateMode.value = "assistant";
    taxRate.value = "0.05";
    rounding.value = "int";

    prodCompany.value = "";
    producer.value = "";
    producerPhone.value = "";
    dp.value = "";
    dpPhone.value = "";
    payType.value = "";
    projectName.value = "";

    setDefaultsToNow();
    applyRateMode();
    calculate();
  });

  // 事件
  rateMode.addEventListener("change", () => {
    if (!ratePerShift.disabled) lastCustomRate = Number(ratePerShift.value || lastCustomRate);
    applyRateMode();
    calculate();
  });

  ratePerShift.addEventListener("input", () => {
    if (!ratePerShift.disabled) lastCustomRate = Number(ratePerShift.value || lastCustomRate);
    calculate();
  });

  [startDT, endDT, taxRate, rounding, prodCompany, producer, producerPhone, dp, dpPhone, payType, projectName].forEach(el => {
    el.addEventListener("input", calculate);
    el.addEventListener("change", calculate);
  });

  // Init
  tz.value = Intl.DateTimeFormat().resolvedOptions().timeZone || "（未知）";
  setDefaultsToNow();
  applyRateMode();
  calculate();
</script>
</body>
</html>
